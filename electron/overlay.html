<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Mirror</title>

    <!-- xterm.js styles and scripts (UMD bundles, not ES modules) -->
    <link rel="stylesheet" href="../node_modules/xterm/css/xterm.css">
    <script src="../node_modules/xterm/lib/xterm.js"></script>
    <script src="../node_modules/xterm-addon-fit/lib/xterm-addon-fit.js"></script>

    <!-- Markdown rendering -->
    <script src="../node_modules/marked/lib/marked.umd.js"></script>
    <script src="../node_modules/dompurify/dist/purify.min.js"></script>

    <!-- Voice Mirror Styles -->
    <link rel="stylesheet" href="styles/tokens.css">
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/orb.css">
    <link rel="stylesheet" href="styles/panel.css">
    <link rel="stylesheet" href="styles/sidebar.css">
    <link rel="stylesheet" href="styles/chat.css">
    <link rel="stylesheet" href="styles/terminal.css">
    <link rel="stylesheet" href="styles/browser.css">
    <link rel="stylesheet" href="styles/settings.css">
    <link rel="stylesheet" href="styles/notifications.css">
</head>
<body>
    <!-- Orb View (collapsed) -->
    <!-- Outer ring: draggable via -webkit-app-region: drag -->
    <!-- Inner button: clickable via -webkit-app-region: no-drag -->
    <div id="orb" class="listening">
        <canvas id="orb-canvas" width="64" height="64"></canvas>
        <button id="orb-button" title="Click to expand"></button>
    </div>

    <!-- Panel View (expanded) -->
    <div id="panel">
        <!-- Sidebar Navigation -->
        <aside id="sidebar">
            <div id="sidebar-header">
                <img class="sidebar-logo" src="../assets/icon-32.png" alt="Voice Mirror" onclick="collapse()">
                <span class="sidebar-title">Voice Mirror</span>
                <div class="window-controls">
                    <button class="win-btn win-minimize" onclick="minimizeWindow()" title="Minimize to taskbar">‚îÄ</button>
                    <button class="win-btn win-collapse" onclick="collapse()" title="Collapse to orb">‚óâ</button>
                    <button class="win-btn win-close" onclick="hideToTray()" title="Close to tray">√ó</button>
                </div>
            </div>
            <nav id="sidebar-nav">
                <button class="nav-item active" data-page="chat" data-tooltip="Chat">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span>Chat</span>
                </button>
                <button class="nav-item" data-page="terminal" data-tooltip="Claude Code" id="nav-terminal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="4 17 10 11 4 5"/>
                        <line x1="12" y1="19" x2="20" y2="19"/>
                    </svg>
                    <span id="nav-terminal-label"></span>
                    <span id="nav-ai-badge" class="nav-badge stopped"></span>
                </button>
                <button class="nav-item" data-page="browser" data-tooltip="Browser" id="nav-browser">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="2" y1="12" x2="22" y2="12"/>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </svg>
                    <span>Browser</span>
                </button>
                <button class="nav-item" data-page="settings" data-tooltip="Settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    <span>Settings</span>
                </button>
            </nav>
            <div id="sidebar-footer">
                <!-- Action Buttons -->
                <div id="sidebar-actions">
                    <button id="call-mode-btn" class="sidebar-action-btn" onclick="toggleCallMode()" title="Call Mode" data-tooltip="Call Mode">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                    </button>
                    <button id="capture-screen-btn" class="sidebar-action-btn" onclick="captureScreen()" title="Capture Screen" data-tooltip="Screenshot">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                    </button>
                </div>
                <!-- Status Indicator -->
                <div id="sidebar-status">
                    <div id="status-indicator"></div>
                    <span id="status-text">Listening...</span>
                </div>
                <!-- Collapse Button -->
                <button id="sidebar-collapse-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"/>
                    </svg>
                    <span>Collapse</span>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="main-content">
            <!-- Chat Page -->
            <div id="page-chat" class="page active">
                <div id="chat-container">
                    <!-- Welcome message - updated dynamically based on activation mode -->
                    <div id="welcome-message" class="message-group assistant">
                        <div class="message-avatar">ü§ñ</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">Voice Mirror</span>
                                <span class="message-time">Now</span>
                            </div>
                            <div id="welcome-bubble" class="message-bubble">
                                Loading...
                                <button class="message-copy-btn" onclick="copyMessage(this)" title="Copy">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Toast Container -->
                <div id="toast-container"></div>

                <!-- Image Preview (shown when image is pasted/dropped) -->
                <div id="image-preview">
                    <img id="preview-image" src="" alt="Preview">
                    <div class="preview-info">
                        <div id="preview-filename">screenshot.png</div>
                        <div id="preview-size">0 KB</div>
                    </div>
                    <div class="preview-actions">
                        <button class="send-btn" onclick="sendImage()">Send</button>
                        <button class="cancel-btn" onclick="cancelImage()">Cancel</button>
                    </div>
                </div>

                <!-- Terminal Panel (at bottom of chat page) - hidden by default -->
                <div id="terminal-container" class="hidden">
                    <div id="terminal-header">
                        <span id="terminal-title" class="terminal-title">‚åò Claude Code</span>
                        <span id="terminal-profile-badge" class="terminal-profile-badge" onclick="openToolProfileSettings()" title="Tool Profile ‚Äî click to change"></span>
                        <span id="terminal-status" class="terminal-status stopped">Stopped</span>
                        <button id="terminal-start" class="control-btn start" onclick="startAI()">Start</button>
                        <button id="terminal-clear" class="control-btn clear" onclick="clearTerminal()" title="Clear terminal">Clear</button>
                        <div class="terminal-controls">
                            <button class="terminal-ctrl-btn" onclick="minimizeTerminal()" title="Minimize">‚îÄ</button>
                            <button class="terminal-ctrl-btn" onclick="relocateTerminal('fullscreen')" title="Move to fullscreen">‚¨Ü</button>
                        </div>
                    </div>
                    <div id="xterm-container"></div>
                </div>
            </div>

            <!-- Terminal Page (full-screen terminal) -->
            <div id="page-terminal" class="page">
                <div id="terminal-fullscreen">
                    <div id="terminal-fullscreen-header">
                        <span id="terminal-fullscreen-title" class="terminal-title">‚åò Claude Code</span>
                        <span id="terminal-fullscreen-profile-badge" class="terminal-profile-badge" onclick="openToolProfileSettings()" title="Tool Profile ‚Äî click to change"></span>
                        <span id="terminal-fullscreen-status" class="terminal-status stopped">Stopped</span>
                        <button id="terminal-fullscreen-start" class="control-btn start" onclick="startAI()">Start</button>
                        <button id="terminal-fullscreen-clear" class="control-btn clear" onclick="clearTerminal()" title="Clear terminal">Clear</button>
                    </div>
                    <div id="xterm-fullscreen-container"></div>
                </div>
            </div>

            <!-- Browser Page -->
            <div id="page-browser" class="page">
                <div id="browser-toolbar">
                    <button id="browser-back" class="browser-nav-btn" title="Back">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    </button>
                    <button id="browser-forward" class="browser-nav-btn" title="Forward">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                    </button>
                    <button id="browser-refresh" class="browser-nav-btn" title="Refresh">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                    </button>
                    <div id="browser-url-bar">
                        <span id="browser-url">about:blank</span>
                    </div>
                    <button id="browser-popout" class="browser-nav-btn" title="Open in external browser">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    </button>
                </div>
                <div id="browser-container">
                    <webview id="browser-webview"
                        src="about:blank"
                        partition="persist:voicemirror-browser"
                        webpreferences="contextIsolation=yes"
                        style="width:100%; height:100%; display:none;">
                    </webview>
                    <div id="browser-idle-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48" style="opacity:0.3;">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="2" y1="12" x2="22" y2="12"/>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                        </svg>
                        <p>No browser active</p>
                        <p class="browser-idle-hint">Ask the assistant to search or open a website</p>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="page-settings" class="page">
                <div id="settings-page-content">
                    <div id="settings-page-header">
                        <h2>Settings</h2>
                    </div>
                    <div id="settings-page-body">
                        <!-- User -->
                        <div class="settings-section">
                            <h3>User</h3>
                            <div class="settings-group">
                                <div class="setting-row">
                                    <label for="user-name">Your Name</label>
                                    <input type="text" id="user-name" placeholder="Enter your name" maxlength="50" class="setting-input">
                                </div>
                            </div>
                        </div>

                        <!-- AI Provider -->
                        <div class="settings-section">
                            <h3>AI Provider</h3>
                            <div class="settings-group">
                                <label class="checkbox-option">
                                    <input type="checkbox" id="ai-auto-detect" checked>
                                    <span>Auto-detect local LLM servers</span>
                                </label>
                                <div id="ai-detected-status" class="detection-status">
                                    <span class="detection-label">Scanning...</span>
                                </div>
                                <div class="setting-row">
                                    <label>Provider</label>
                                    <div class="provider-selector" id="ai-provider-selector">
                                        <button class="provider-selector-btn" id="ai-provider-btn" type="button">
                                            <span class="provider-icon" id="selected-provider-icon"></span>
                                            <span class="provider-name" id="selected-provider-name">Claude Code</span>
                                            <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="6 9 12 15 18 9"/>
                                            </svg>
                                        </button>
                                        <div class="provider-dropdown" id="ai-provider-dropdown">
                                            <div class="provider-group">
                                                <div class="provider-group-label">CLI Agents <span class="group-badge cli-badge">Terminal Access</span></div>
                                                <div class="provider-option" data-value="claude">
                                                    <span class="provider-icon provider-icon-claude"></span>
                                                    <span>Claude Code</span>
                                                    <span class="provider-badge">MCP</span>
                                                </div>
                                                <div class="provider-option" data-value="codex">
                                                    <span class="provider-icon provider-icon-codex"></span>
                                                    <span>OpenAI Codex</span>
                                                </div>
                                                <div class="provider-option" data-value="gemini-cli">
                                                    <span class="provider-icon provider-icon-gemini-cli"></span>
                                                    <span>Gemini CLI</span>
                                                </div>
                                                <div class="provider-option" data-value="kimi-cli">
                                                    <span class="provider-icon provider-icon-kimi"></span>
                                                    <span>Kimi CLI</span>
                                                    <span class="provider-badge mcp">MCP</span>
                                                </div>
                                            </div>
                                            <div class="provider-group">
                                                <div class="provider-group-label">Local (Auto-detected)</div>
                                                <div class="provider-option" data-value="ollama">
                                                    <span class="provider-icon provider-icon-ollama"></span>
                                                    <span>Ollama</span>
                                                </div>
                                                <div class="provider-option" data-value="lmstudio">
                                                    <span class="provider-icon provider-icon-lmstudio"></span>
                                                    <span>LM Studio</span>
                                                </div>
                                                <div class="provider-option" data-value="jan">
                                                    <span class="provider-icon provider-icon-jan"></span>
                                                    <span>Jan</span>
                                                </div>
                                            </div>
                                            <div class="provider-group">
                                                <div class="provider-group-label">Cloud API</div>
                                                <div class="provider-option" data-value="openai">
                                                    <span class="provider-icon provider-icon-openai"></span>
                                                    <span>OpenAI</span>
                                                </div>
                                                <div class="provider-option" data-value="gemini">
                                                    <span class="provider-icon provider-icon-gemini"></span>
                                                    <span>Google Gemini</span>
                                                </div>
                                                <div class="provider-option" data-value="grok">
                                                    <span class="provider-icon provider-icon-grok"></span>
                                                    <span>Grok (xAI)</span>
                                                </div>
                                                <div class="provider-option" data-value="groq">
                                                    <span class="provider-icon provider-icon-groq"></span>
                                                    <span>Groq</span>
                                                </div>
                                                <div class="provider-option" data-value="mistral">
                                                    <span class="provider-icon provider-icon-mistral"></span>
                                                    <span>Mistral</span>
                                                </div>
                                                <div class="provider-option" data-value="openrouter">
                                                    <span class="provider-icon provider-icon-openrouter"></span>
                                                    <span>OpenRouter</span>
                                                </div>
                                                <div class="provider-option" data-value="deepseek">
                                                    <span class="provider-icon provider-icon-deepseek"></span>
                                                    <span>DeepSeek</span>
                                                </div>
                                                <div class="provider-option" data-value="kimi">
                                                    <span class="provider-icon provider-icon-kimi"></span>
                                                    <span>Kimi (Moonshot)</span>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Hidden input for form value -->
                                        <input type="hidden" id="ai-provider" value="claude">
                                    </div>
                                </div>
                                <div class="settings-info-box cli-warning" id="cli-warning" style="display: none;">
                                    CLI Agent &mdash; This provider has full terminal access and can execute commands on your system.
                                </div>
                                <div class="setting-row" id="ai-model-row">
                                    <label>Model</label>
                                    <select id="ai-model">
                                        <option value="">Auto (default)</option>
                                    </select>
                                </div>
                                <div class="setting-row" id="ai-context-length-row" style="display: none;">
                                    <label>Context Length</label>
                                    <select id="ai-context-length">
                                        <option value="4096">4K (4,096 tokens)</option>
                                        <option value="8192">8K (8,192 tokens)</option>
                                        <option value="16384">16K (16,384 tokens)</option>
                                        <option value="32768" selected>32K (32,768 tokens)</option>
                                        <option value="65536">64K (65,536 tokens)</option>
                                        <option value="131072">128K (131,072 tokens)</option>
                                    </select>
                                </div>
                                <div class="setting-row" id="ai-endpoint-row" style="display: none;">
                                    <label>Endpoint</label>
                                    <input type="text" id="ai-endpoint" placeholder="http://127.0.0.1:11434">
                                </div>
                                <div class="setting-row" id="ai-apikey-row" style="display: none;">
                                    <label>API Key</label>
                                    <input type="password" id="ai-apikey" placeholder="Enter API key...">
                                </div>
                                <button class="settings-btn secondary" id="ai-scan-btn" onclick="scanProviders()">
                                    Scan Now
                                </button>
                            </div>
                        </div>

                        <!-- Tool Profiles (Claude Code only) -->
                        <div class="settings-section" id="tool-profile-section" style="display: none;">
                            <h3>Tool Profiles</h3>
                            <div class="settings-group">
                                <div class="setting-row">
                                    <label>Active Profile</label>
                                    <div class="profile-selector" id="profile-selector">
                                        <button class="profile-selector-btn" id="profile-selector-btn">
                                            <span class="profile-name" id="profile-name">Voice Assistant</span>
                                            <span class="profile-arrow">‚ñæ</span>
                                        </button>
                                        <div class="profile-dropdown" id="profile-dropdown">
                                            <div class="profile-group-label">Presets</div>
                                            <div class="profile-option" data-profile="voice-assistant">
                                                <span class="profile-option-name">Voice Assistant</span>
                                                <span class="profile-option-desc">screen, memory</span>
                                            </div>
                                            <div class="profile-option" data-profile="n8n-workflows">
                                                <span class="profile-option-name">n8n Workflows</span>
                                                <span class="profile-option-desc">n8n automation</span>
                                            </div>
                                            <div class="profile-option" data-profile="web-browser">
                                                <span class="profile-option-name">Web Browser</span>
                                                <span class="profile-option-desc">screen, browser</span>
                                            </div>
                                            <div class="profile-option" data-profile="full-toolbox">
                                                <span class="profile-option-name">Full Toolbox</span>
                                                <span class="profile-option-desc">all 48 tools</span>
                                            </div>
                                            <div class="profile-option" data-profile="minimal">
                                                <span class="profile-option-name">Minimal</span>
                                                <span class="profile-option-desc">voice I/O only</span>
                                            </div>
                                            <div class="profile-group-label" id="custom-profiles-label" style="display: none;">Custom</div>
                                            <div id="custom-profiles-container"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="tool-group-list" id="tool-group-list">
                                    <label class="tool-group-item">
                                        <input type="checkbox" value="core" checked disabled>
                                        <span class="tool-group-name">core <span class="tool-group-count">(4)</span></span>
                                        <span class="tool-group-desc">Voice I/O</span>
                                        <span class="tool-group-badge">always on</span>
                                    </label>
                                    <label class="tool-group-item">
                                        <input type="checkbox" value="meta" checked disabled>
                                        <span class="tool-group-name">meta <span class="tool-group-count">(3)</span></span>
                                        <span class="tool-group-desc">Dynamic loading</span>
                                        <span class="tool-group-badge">always on</span>
                                    </label>
                                    <label class="tool-group-item">
                                        <input type="checkbox" value="screen" data-group="screen">
                                        <span class="tool-group-name">screen <span class="tool-group-count">(1)</span></span>
                                        <span class="tool-group-desc">Screenshots</span>
                                    </label>
                                    <label class="tool-group-item">
                                        <input type="checkbox" value="memory" data-group="memory">
                                        <span class="tool-group-name">memory <span class="tool-group-count">(5)</span></span>
                                        <span class="tool-group-desc">Persistent memory</span>
                                    </label>
                                    <label class="tool-group-item">
                                        <input type="checkbox" value="voice-clone" data-group="voice-clone">
                                        <span class="tool-group-name">voice-clone <span class="tool-group-count">(3)</span></span>
                                        <span class="tool-group-desc">Voice cloning</span>
                                    </label>
                                    <label class="tool-group-item">
                                        <input type="checkbox" value="browser" data-group="browser">
                                        <span class="tool-group-name">browser <span class="tool-group-count">(14)</span></span>
                                        <span class="tool-group-desc">Browser automation</span>
                                    </label>
                                    <label class="tool-group-item">
                                        <input type="checkbox" value="n8n" data-group="n8n">
                                        <span class="tool-group-name">n8n <span class="tool-group-count">(22)</span></span>
                                        <span class="tool-group-desc">Workflow automation</span>
                                    </label>
                                </div>

                                <div class="tool-profile-footer">
                                    <span class="tool-count" id="tool-count">7 of 48 tools</span>
                                    <div class="tool-profile-actions">
                                        <button class="settings-btn secondary small" id="save-profile-btn" onclick="saveCustomProfile()">Save as Profile</button>
                                        <button class="settings-btn danger small" id="delete-profile-btn" style="display: none;" onclick="deleteCurrentProfile()">Delete</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Activation Mode -->
                        <div class="settings-section">
                            <h3>Activation Mode</h3>
                            <div class="settings-group">
                                <label class="radio-option">
                                    <input type="radio" name="activationMode" value="wakeWord" checked>
                                    <span class="radio-label">Wake Word</span>
                                    <span class="radio-desc" id="wakeWordDesc">Say the wake word to activate</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="activationMode" value="callMode">
                                    <span class="radio-label">Call Mode</span>
                                    <span class="radio-desc">Always listening, no wake word needed</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="activationMode" value="pushToTalk">
                                    <span class="radio-label">Push to Talk</span>
                                    <span class="radio-desc">Hold a key to record</span>
                                </label>
                            </div>
                        </div>

                        <!-- Keybinds -->
                        <div class="settings-section">
                            <h3>Keyboard Shortcuts</h3>
                            <div class="settings-group">
                                <div class="keybind-row">
                                    <span class="keybind-label">Toggle Panel</span>
                                    <button class="keybind-input" id="keybind-toggle" data-key="behavior.hotkey">
                                        Ctrl+Shift+V
                                    </button>
                                </div>
                                <div class="keybind-row" id="ptt-keybind-row" style="display: none;">
                                    <span class="keybind-label">Push to Talk</span>
                                    <button class="keybind-input" id="keybind-ptt" data-key="behavior.pttKey">
                                        Space
                                    </button>
                                </div>
                                <div class="keybind-row">
                                    <span class="keybind-label">Toggle Stats</span>
                                    <button class="keybind-input" id="keybind-stats" data-key="behavior.statsHotkey">
                                        Ctrl+Shift+M
                                    </button>
                                </div>
                            </div>
                            <p class="settings-hint">Click a button, then press a key or mouse button (side buttons supported)</p>
                        </div>

                        <!-- Wake Word Settings -->
                        <div class="settings-section" id="wake-word-settings">
                            <h3>Wake Word</h3>
                            <div class="settings-group">
                                <div class="setting-row">
                                    <label>Phrase</label>
                                    <select id="wake-word-phrase">
                                        <option value="hey_claude">Hey Claude</option>
                                        <option value="hey_jarvis">Hey Jarvis</option>
                                        <option value="alexa">Alexa</option>
                                    </select>
                                </div>
                                <div class="setting-row">
                                    <label>Sensitivity</label>
                                    <div class="slider-container">
                                        <input type="range" id="wake-word-sensitivity" min="0.1" max="0.9" step="0.1" value="0.5">
                                        <span id="sensitivity-value">0.5</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Voice Settings -->
                        <div class="settings-section">
                            <h3>Voice</h3>
                            <div class="settings-group">
                                <div class="setting-row">
                                    <label>TTS Engine</label>
                                    <select id="tts-adapter">
                                        <option value="kokoro">Kokoro (Fast, ~100MB)</option>
                                        <option value="qwen">Qwen3-TTS (Voice cloning, ~3-7GB download)</option>
                                    </select>
                                </div>
                                <div class="setting-row" id="tts-model-size-row" style="display: none;">
                                    <label>Model Size</label>
                                    <select id="tts-model-size">
                                        <option value="0.6B">0.6B (~1.5GB disk, ~2GB VRAM)</option>
                                        <option value="1.7B">1.7B (~3.5GB disk, ~4GB VRAM)</option>
                                    </select>
                                </div>
                                <p class="settings-hint" id="tts-qwen-hint" style="display: none;">
                                    ‚ö†Ô∏è Qwen3-TTS downloads models on first use (~3-7GB). Voice cloning requires both Base + CustomVoice models.
                                </p>
                                <div class="setting-row" id="tts-voice-row">
                                    <label>TTS Voice</label>
                                    <select id="tts-voice">
                                        <!-- Kokoro voices (default) -->
                                        <option value="af_bella">Bella (Female)</option>
                                        <option value="af_nicole">Nicole (Female)</option>
                                        <option value="af_sarah">Sarah (Female)</option>
                                        <option value="am_adam">Adam (Male)</option>
                                        <option value="am_michael">Michael (Male)</option>
                                        <option value="bf_emma">Emma (British)</option>
                                        <option value="bm_george">George (British)</option>
                                    </select>
                                </div>
                                <div class="setting-row">
                                    <label>Speech Speed</label>
                                    <div class="slider-container">
                                        <input type="range" id="tts-speed" min="0.5" max="2.0" step="0.1" value="1.0">
                                        <span id="speed-value">1.0x</span>
                                    </div>
                                </div>
                                <div class="setting-row">
                                    <label>TTS Volume</label>
                                    <div class="slider-container">
                                        <input type="range" id="tts-volume" min="0.1" max="2.0" step="0.1" value="1.0">
                                        <span id="volume-value">100%</span>
                                    </div>
                                </div>
                                <div class="setting-row">
                                    <label>STT Model</label>
                                    <select id="stt-model">
                                        <option value="parakeet">Parakeet (Fast)</option>
                                        <option value="whisper">Whisper (Accurate)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Audio Devices -->
                        <div class="settings-section" id="audio-device-section">
                            <h3>Audio</h3>
                            <div class="settings-group">
                                <div class="setting-row">
                                    <label>Input Device</label>
                                    <select id="audio-input-device">
                                        <option value="">System Default</option>
                                    </select>
                                </div>
                                <div class="setting-row">
                                    <label>Output Device</label>
                                    <select id="audio-output-device">
                                        <option value="">System Default</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Overlay Display -->
                        <div class="settings-section" id="overlay-display-section" style="display: none;">
                            <h3>Overlay Display</h3>
                            <div class="settings-group">
                                <div class="setting-row">
                                    <label>Monitor</label>
                                    <select id="overlay-output">
                                        <option value="">Default</option>
                                    </select>
                                </div>
                                <p class="settings-hint">Choose which monitor displays the overlay orb</p>
                            </div>
                        </div>

                        <!-- Appearance -->
                        <div class="settings-section">
                            <h3>Appearance</h3>
                            <div class="settings-group">
                                <div class="setting-row">
                                    <label>Orb Size</label>
                                    <div class="slider-container">
                                        <input type="range" id="orb-size" min="48" max="96" step="8" value="64">
                                        <span id="orb-size-value">64px</span>
                                    </div>
                                </div>
                                <div class="setting-row">
                                    <label>Theme</label>
                                    <span class="theme-static-value">Dark</span>
                                    <input type="hidden" id="theme-select" value="dark">
                                </div>
                            </div>
                        </div>

                        <!-- Behavior -->
                        <div class="settings-section">
                            <h3>Behavior</h3>
                            <div class="settings-group">
                                <label class="checkbox-option">
                                    <input type="checkbox" id="start-minimized">
                                    <span>Start minimized to tray</span>
                                </label>
                                <label class="checkbox-option">
                                    <input type="checkbox" id="start-with-system">
                                    <span>Start with system</span>
                                </label>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="settings-actions">
                            <button class="settings-btn secondary" onclick="resetSettings()">Reset to Defaults</button>
                            <button class="settings-btn primary" onclick="saveSettings()">Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Drop zone overlay -->
            <div id="drop-zone">Drop image here</div>

            <!-- Performance Stats Bar (inside main so hidden when collapsed) -->
            <div id="perf-stats-bar" class="perf-stats-bar">
                <span id="perf-cpu">CPU: --%</span>
                <span class="perf-sep">|</span>
                <span id="perf-mem">MEM: --MB</span>
                <span id="perf-ctx-sep" class="perf-sep" style="display:none">|</span>
                <span id="perf-ctx" style="display:none">CTX: --</span>
            </div>
        </main>
    </div>

    <!-- Terminal Context Menu -->
    <div id="terminal-context-menu" class="context-menu hidden">
        <button class="context-menu-item" data-action="snap-to-chat">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="17 11 12 6 7 11"/>
                <polyline points="17 18 12 13 7 18"/>
            </svg>
            <span>Snap to Chat</span>
        </button>
        <button class="context-menu-item" data-action="show-fullscreen">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 3 21 3 21 9"/>
                <polyline points="9 21 3 21 3 15"/>
                <line x1="21" y1="3" x2="14" y2="10"/>
                <line x1="3" y1="21" x2="10" y2="14"/>
            </svg>
            <span>Show Fullscreen</span>
        </button>
    </div>

    <!-- Name Required Modal (shown on first run if no name configured) -->
    <div id="name-required-overlay" class="name-required-overlay" style="display:none">
        <div class="name-required-modal">
            <h2>Welcome to Voice Mirror</h2>
            <p>What should I call you?</p>
            <input type="text" id="name-required-input" placeholder="Your name or nickname" maxlength="50" autofocus>
            <button id="name-required-submit" class="btn-primary" disabled>Continue</button>
        </div>
    </div>

    <!-- Voice Mirror Scripts (ES modules) -->
    <script type="module" src="js/main.js"></script>
</body>
</html>
