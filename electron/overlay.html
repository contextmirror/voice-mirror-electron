<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval';
        style-src 'self' 'unsafe-inline';
        font-src 'self' data:;
        img-src 'self' data: blob:;
        connect-src 'self' data:;
        media-src 'self' blob: mediastream:;
        worker-src 'self' blob:;
    ">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Mirror</title>

    <!-- ghostty-web terminal emulator (UMD bundle + WASM) -->
    <script defer src="../node_modules/ghostty-web/dist/ghostty-web.umd.cjs"></script>

    <!-- Markdown rendering -->
    <script defer src="../node_modules/marked/lib/marked.umd.js"></script>
    <script defer src="../node_modules/dompurify/dist/purify.min.js"></script>

    <!-- Voice Mirror Styles -->
    <link rel="stylesheet" href="renderer/styles/fonts.css">
    <link rel="stylesheet" href="renderer/styles/tokens.css">
    <link rel="stylesheet" href="renderer/styles/base.css">
    <link rel="stylesheet" href="renderer/styles/orb.css">
    <link rel="stylesheet" href="renderer/styles/panel.css">
    <link rel="stylesheet" href="renderer/styles/sidebar.css">
    <link rel="stylesheet" href="renderer/styles/chat.css">
    <link rel="stylesheet" href="renderer/styles/terminal.css">
    <link rel="stylesheet" href="renderer/styles/browser.css">
    <link rel="stylesheet" href="renderer/styles/settings.css">
    <link rel="stylesheet" href="renderer/styles/notifications.css">
    <link rel="stylesheet" href="renderer/styles/whats-new.css">
</head>
<body>
    <!-- Orb View (collapsed) -->
    <!-- Outer ring: draggable via -webkit-app-region: drag -->
    <!-- Inner button: clickable via -webkit-app-region: no-drag -->
    <div id="orb" class="listening">
        <canvas id="orb-canvas" width="64" height="64"></canvas>
        <button id="orb-button" title="Click to expand" aria-label="Expand panel"></button>
    </div>

    <!-- Resize edges for frameless window (visible only when panel expanded) -->
    <div id="resize-edges">
        <div class="resize-edge resize-n"></div>
        <div class="resize-edge resize-s"></div>
        <div class="resize-edge resize-e"></div>
        <div class="resize-edge resize-w"></div>
        <div class="resize-edge resize-nw"></div>
        <div class="resize-edge resize-ne"></div>
        <div class="resize-edge resize-sw"></div>
        <div class="resize-edge resize-se"></div>
    </div>

    <!-- Panel View (expanded) -->
    <div id="panel">
        <!-- Titlebar (full-width, draggable) -->
        <div id="titlebar">
            <img class="titlebar-logo" src="../assets/icon-32.png" alt="Voice Mirror">
            <span class="titlebar-title">Voice Mirror</span>
            <div class="window-controls">
                <button class="win-btn win-collapse" onclick="collapse()" title="Collapse to orb" aria-label="Collapse sidebar">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><circle cx="12" cy="12" r="5"/></svg>
                </button>
                <button class="win-btn win-minimize" onclick="minimizeWindow()" title="Minimize" aria-label="Minimize">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                </button>
                <button class="win-btn win-maximize" onclick="maximizeWindow()" title="Maximize" aria-label="Maximize">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><rect x="5" y="5" width="14" height="14" rx="1"/></svg>
                </button>
                <button class="win-btn win-close" onclick="quitApp()" title="Close" aria-label="Close">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="6" y1="6" x2="18" y2="18"/><line x1="18" y1="6" x2="6" y2="18"/></svg>
                </button>
            </div>
        </div>

        <!-- Panel Body (sidebar + main content) -->
        <div id="panel-body">
        <!-- Sidebar Navigation -->
        <aside id="sidebar">
            <!-- Chat History -->
            <div id="sidebar-chats">
                <div class="sidebar-section-header">
                    <span>Chats</span>
                    <button id="new-chat-btn" title="New Chat" aria-label="New chat">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"/>
                            <line x1="5" y1="12" x2="19" y2="12"/>
                        </svg>
                    </button>
                </div>
                <ul id="chat-list" class="sidebar-chat-list"></ul>
            </div>
            <nav id="sidebar-nav">
                <button class="nav-item active" data-page="chat" data-tooltip="Chat">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span>Chat</span>
                </button>
                <button class="nav-item" data-page="terminal" data-tooltip="Terminal" id="nav-terminal" style="display:none">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="4 17 10 11 4 5"/>
                        <line x1="12" y1="19" x2="20" y2="19"/>
                    </svg>
                    <span class="nav-label-group">
                        <span id="nav-terminal-label"></span>
                        <span class="nav-provider-sub" id="nav-terminal-provider">
                            <span class="provider-icon" id="nav-provider-icon"></span>
                            <span id="nav-provider-name"></span>
                        </span>
                    </span>
                    <span id="nav-ai-badge" class="nav-badge stopped"></span>
                </button>
                <button class="nav-item" data-page="browser" data-tooltip="Browser" id="nav-browser">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="2" y1="12" x2="22" y2="12"/>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                    </svg>
                    <span>Browser</span>
                </button>
                <button class="nav-item" data-page="settings" data-tooltip="Settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    <span>Settings</span>
                </button>
            </nav>
            <div id="sidebar-footer">
                <!-- Update Banner (hidden until update available) -->
                <div id="sidebar-update-banner" style="display: none;">
                    <svg class="update-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    <span id="update-banner-text">Update available</span>
                    <button id="update-banner-btn">Update</button>
                    <button id="update-banner-dismiss" style="display: none;" title="Dismiss" aria-label="Dismiss update">&times;</button>
                </div>
                <!-- Action Buttons -->
                <div id="sidebar-actions">
                    <button id="capture-screen-btn" class="sidebar-action-btn" onclick="captureScreen()" title="Capture Screen" data-tooltip="Screenshot" aria-label="Take screenshot">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                    </button>
                </div>
                <!-- Status Indicator -->
                <div id="sidebar-status">
                    <div id="status-indicator"></div>
                    <span id="status-text">Listening...</span>
                    <button id="voice-reconnect-btn" class="reconnect-btn" style="display: none;">Reconnect</button>
                </div>
                <!-- Collapse Button -->
                <button id="sidebar-collapse-btn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"/>
                    </svg>
                    <span>Collapse</span>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="main-content">
            <!-- Chat Page -->
            <div id="page-chat" class="page active">
                <div id="chat-container">
                    <!-- Welcome message - updated dynamically based on activation mode -->
                    <div id="welcome-message" class="message-group assistant">
                        <div class="message-avatar">ðŸ¤–</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">Voice Mirror</span>
                                <span class="message-time">Now</span>
                            </div>
                            <div id="welcome-bubble" class="message-bubble">
                                Loading...
                                <button class="message-copy-btn" onclick="copyMessage(this)" title="Copy" aria-label="Copy message">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Toast Container -->
                <div id="toast-container"></div>

                <!-- Image Preview (shown when image is pasted/dropped) -->
                <div id="image-preview">
                    <img id="preview-image" src="" alt="Preview">
                    <div class="preview-info">
                        <div id="preview-filename">screenshot.png</div>
                        <div id="preview-size">0 KB</div>
                    </div>
                    <div class="preview-actions">
                        <button class="send-btn" onclick="sendImage()">Send</button>
                        <button class="cancel-btn" onclick="cancelImage()">Cancel</button>
                    </div>
                </div>

                <!-- Chat Input Bar -->
                <div id="chat-input-bar">
                    <!-- AI Activity Status Bar -->
                    <div id="ai-status-bar">
                        <span id="ai-status-icon">|&gt;</span>
                        <span id="ai-status-text">Waiting for input</span>
                        <div id="chat-scroll-buttons">
                            <button class="chat-scroll-btn" id="scroll-to-top" title="Scroll to top" aria-label="Scroll to top">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="18 15 12 9 6 15"/>
                                </svg>
                            </button>
                            <button class="chat-scroll-btn" id="scroll-to-bottom" title="Scroll to bottom" aria-label="Scroll to bottom">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="chat-input-row">
                        <textarea id="chat-input" placeholder="Type a message..." rows="1"></textarea>
                        <!-- Waveform overlay shown during voice recording -->
                        <div id="voice-waveform" class="hidden">
                            <div class="waveform-bars"></div>
                        </div>
                        <button id="chat-send-btn" title="Send message" aria-label="Send message">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"/>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                            </svg>
                        </button>
                    </div>
                    <div id="chat-actions-row">
                        <button class="chat-action-btn interrupt" id="action-interrupt-ai" title="Interrupt AI" aria-label="Interrupt">
                            <svg viewBox="0 0 24 24" fill="currentColor" width="12" height="12">
                                <rect x="6" y="4" width="4" height="16" rx="1"/>
                                <rect x="14" y="4" width="4" height="16" rx="1"/>
                            </svg>
                            <span>Pause</span>
                        </button>
                        <button class="chat-action-btn" id="action-clear-chat" title="Clear chat" aria-label="Clear chat">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                                <path d="M10 11v6"/>
                                <path d="M14 11v6"/>
                                <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
                            </svg>
                            <span>Clear</span>
                        </button>
                        <button class="chat-action-btn" id="action-save-chat" title="Save chat">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                <polyline points="17 21 17 13 7 13 7 21"/>
                                <polyline points="7 3 7 8 15 8"/>
                            </svg>
                            <span>Save</span>
                        </button>
                    </div>
                </div>

                <!-- Terminal Panel (at bottom of chat page) - hidden by default -->
                <div id="terminal-container" class="hidden">
                    <div id="terminal-header">
                        <span id="terminal-title" class="terminal-title">âŒ˜ AI Provider</span>
                        <span id="terminal-profile-badge" class="terminal-profile-badge" onclick="openToolProfileSettings()" title="Tool Profile â€” click to change"></span>
                        <span id="terminal-status" class="terminal-status stopped">Stopped</span>
                        <button id="terminal-start" class="control-btn start" onclick="startAI()">Start</button>
                        <button id="terminal-clear" class="control-btn clear" onclick="clearTerminal()" title="Clear terminal">Clear</button>
                        <div class="terminal-controls">
                            <button class="terminal-ctrl-btn" onclick="minimizeTerminal()" title="Minimize" aria-label="Minimize terminal">â”€</button>
                        </div>
                    </div>
                    <div id="terminal-mount"></div>
                </div>
            </div>

            <!-- Terminal Page (full-screen terminal) -->
            <div id="page-terminal" class="page">
                <div id="terminal-fullscreen">
                    <div id="terminal-fullscreen-header">
                        <span id="terminal-fullscreen-title" class="terminal-title">âŒ˜ AI Provider</span>
                        <span id="terminal-fullscreen-profile-badge" class="terminal-profile-badge" onclick="openToolProfileSettings()" title="Tool Profile â€” click to change"></span>
                        <span id="terminal-fullscreen-status" class="terminal-status stopped">Stopped</span>
                        <button id="terminal-fullscreen-start" class="control-btn start" onclick="startAI()">Start</button>
                        <button id="terminal-fullscreen-clear" class="control-btn clear" onclick="clearTerminal()" title="Clear terminal">Clear</button>
                    </div>
                    <div id="terminal-fullscreen-mount"></div>
                </div>
            </div>

            <!-- Browser Page -->
            <div id="page-browser" class="page">
                <div id="browser-toolbar">
                    <button id="browser-back" class="browser-nav-btn" title="Back" aria-label="Go back">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                    </button>
                    <button id="browser-forward" class="browser-nav-btn" title="Forward" aria-label="Go forward">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                    </button>
                    <button id="browser-refresh" class="browser-nav-btn" title="Refresh" aria-label="Refresh page">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                    </button>
                    <div id="browser-url-bar">
                        <span id="browser-url">about:blank</span>
                    </div>
                    <button id="browser-popout" class="browser-nav-btn" title="Open in external browser" aria-label="Open in browser">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    </button>
                </div>
                <div id="browser-container">
                    <webview id="browser-webview"
                        src="about:blank"
                        partition="persist:voicemirror-browser"
                        webpreferences="contextIsolation=yes"
                        style="width:100%; height:100%; display:none;">
                    </webview>
                    <div id="browser-idle-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48" style="opacity:0.3;">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="2" y1="12" x2="22" y2="12"/>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                        </svg>
                        <p>No browser active</p>
                        <p class="browser-idle-hint">Ask the assistant to search or open a website</p>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="page-settings" class="page">
                <div id="settings-page-content">
                    <div id="settings-page-header">
                        <h2>Settings</h2>
                    </div>

                    <!-- Tab Navigation (generated by JS from SETTINGS_TABS registry) -->
                    <div class="settings-tabs"></div>

                    <div id="settings-page-body">

                        <!-- Tab content loaded from templates/settings-{id}.html -->
                        <div class="settings-tab-content" data-tab="ai"></div>
                        <div class="settings-tab-content" data-tab="voice"></div>
                        <div class="settings-tab-content" data-tab="general"></div>
                        <div class="settings-tab-content" data-tab="appearance"></div>
                        <div class="settings-tab-content" data-tab="dependencies"></div>

                        <!-- Actions (always visible, outside tabs) -->
                        <div class="settings-actions">
                            <button class="settings-btn secondary" onclick="resetSettings()">Reset to Defaults</button>
                            <button class="settings-btn primary" onclick="saveSettings()">Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Drop zone overlay -->
            <div id="drop-zone">Drop image here</div>

            <!-- Performance Stats Bar (inside main so hidden when collapsed) -->
            <div id="perf-stats-bar" class="perf-stats-bar">
                <span id="perf-cpu">CPU: --%</span>
                <span class="perf-sep">|</span>
                <span id="perf-mem">MEM: --MB</span>
                <span id="perf-ctx-sep" class="perf-sep" style="display:none">|</span>
                <span id="perf-ctx" style="display:none">CTX: --</span>
            </div>
        </main>
        </div><!-- /panel-body -->
    </div>

    <!-- Disclaimer Modal (shown on first launch before anything else) -->
    <div id="disclaimer-overlay" class="disclaimer-overlay" style="display:none">
        <div class="disclaimer-modal">
            <div class="disclaimer-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#fbbf24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
            </div>
            <h2>Welcome to Voice Mirror</h2>
            <p class="disclaimer-subtitle">Voice-controlled AI agent overlay for your computer</p>
            <div class="disclaimer-warning">
                <strong>Important:</strong> This app gives AI agents full terminal access to your computer. It can read, write, and execute anything your user account can. This is required for voice-controlled operation â€” the AI cannot ask for permission mid-conversation.
            </div>
            <p class="disclaimer-detail">By using this app, you acknowledge that AI agents may execute commands, access files, and interact with services on your behalf. Use with the same caution you would give any tool with system-level access.</p>
            <div class="disclaimer-links">
                <a href="#" id="disclaimer-github">GitHub</a>
                <span class="disclaimer-sep">&middot;</span>
                <a href="#" id="disclaimer-issues">Report a Bug</a>
                <span class="disclaimer-sep">&middot;</span>
                <a href="#" id="disclaimer-star">Star the Project</a>
            </div>
            <div class="disclaimer-buttons">
                <button id="disclaimer-decline" class="btn-decline">Decline</button>
                <button id="disclaimer-accept" class="btn-accept">I Understand &amp; Accept</button>
            </div>
        </div>
    </div>

    <!-- Name Required Modal (shown on first run if no name configured) -->
    <div id="name-required-overlay" class="name-required-overlay" style="display:none">
        <div class="name-required-modal">
            <h2>Welcome to Voice Mirror</h2>
            <p>What should I call you?</p>
            <input type="text" id="name-required-input" placeholder="Your name or nickname" maxlength="50" autofocus>
            <button id="name-required-submit" class="btn-primary" disabled>Continue</button>
        </div>
    </div>

    <!-- What's New Modal (shown after app update) -->
    <div id="whats-new-overlay" class="whats-new-overlay" style="display:none">
        <div class="whats-new-modal">
            <div class="whats-new-header">
                <h2>What's New</h2>
                <button id="whats-new-close" class="whats-new-close-btn" aria-label="Close">&times;</button>
            </div>
            <div id="whats-new-body" class="whats-new-body"></div>
        </div>
    </div>

    <!-- Voice Mirror Scripts (ES modules) -->
    <script type="module" src="renderer/main.js"></script>
</body>
</html>
